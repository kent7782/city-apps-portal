var App=function(e,t,n){function a(){v=new google.maps.places.Autocomplete(n.getElementById("city-input"),{types:["(cities)"]}),w=new google.maps.Geocoder;var t=n.getElementById("city-input");h(t),google.maps.event.addDomListener(t,"keydown",function(e){13===e.keyCode&&e.preventDefault()}),L.css("opacity",0).animate({opacity:1},2800),o(),v.addListener("place_changed",r),R.on("click",function(){C.toggleClass("dropdown-open")}),E.bind("scroll mousedown DOMMouseScroll mousewheel keyup",function(){E.stop()}),x.scroll(function(){e(this).scrollTop()>1.5*x.height()?D.fadeIn():D.fadeOut()}),D.click(function(){return E.animate({scrollTop:0},800),!1}),C.click(function(t){if(t.target.matches(".dropdown-item")){var n=e(t.target),a=n.data("genreid"),o=n.text();R.data("genreid",a),_.text(o)}}),x.click(function(e){e.target.matches("#purpose-label")||e.target.matches("#purpose-text")||e.target.matches("#dropdown-icon")||C.hasClass("dropdown-open")&&C.removeClass("dropdown-open")}),N.click(function(e){e.preventDefault(),i()}),F.click(function(e){e.preventDefault(),S.submit()}),S.submit(function(e){e.preventDefault(),c()})}function o(){var t=[{genreid:"6003",name:"Travel"},{genreid:"6000",name:"Business"},{genreid:"6023",name:"Food and Drink"},{genreid:"6016",name:"Entertainment"},{genreid:"6011",name:"Music"},{genreid:"6012",name:"Lifestyle"},{genreid:"6004",name:"Sports"},{genreid:"6005",name:"Social Networking"},{genreid:"6009",name:"News"},{genreid:"6015",name:"Finance"},{genreid:"6020",name:"Medical"},{genreid:"6013",name:"Health and Fitness"},{genreid:"6010",name:"Navigation"},{genreid:"6001",name:"Weather"},{genreid:"6002",name:"Utilities"},{genreid:"6008",name:"Photo and Video"},{genreid:"6014",name:"Games"},{genreid:"6007",name:"Productivity"},{genreid:"6017",name:"Education"},{genreid:"6018",name:"Books"},{genreid:"6021",name:"Newsstand"},{genreid:"6006",name:"Reference"},{genreid:"6022",name:"Catalogs"}];t.forEach(function(t){C.append(e("<li/>",{"class":"dropdown-item","data-genreid":t.genreid,text:t.name}))})}function r(){var e=v.getPlace();if(!e.geometry)return void(k=!1);k=!0;var t=e.formatted_address,n=e.address_components,a=d(t,n,!1);s(a)}function i(){return y?void s(y):void(navigator.geolocation?(O.attr("placeholder","Locating..."),O.val(""),O.prop("disabled",!0),navigator.geolocation.getCurrentPosition(function(t){var n=t.coords.latitude,a=t.coords.longitude,o=new google.maps.LatLng(n,a);w.geocode({latLng:o},function(t,n){n==google.maps.GeocoderStatus.OK?t[1]?e.each(t,function(e,t){if(k=!0,"locality"==t.types[0]){var n=t.formatted_address,a=t.address_components,o=d(n,a,!0);return s(o),void O.prop("disabled",!1)}}):(u("No results found."),O.prop("disabled",!1),O.attr("placeholder",""),k=!1):(alert("Geocoder failed due to: "+n),O.prop("disabled",!1),O.attr("placeholder",""),k=!1)})},function(e){O.prop("disabled",!1),O.attr("placeholder",""),u("Your location detection is disabled."),k=!1})):u("Your browser doen not support geolocation."))}function d(e,t,n){var a,o=t[0].long_name,r=t[t.length-1].short_name;t[3]&&(a=t[3].short_name);var i;if("US"===r||"US"===a){t[2].short_name;i=e.substring(0,e.indexOf(",")+4)}else i="GB"===r?e:o+", "+r;return n&&(y=i),b=r.toLowerCase(),b.length>2&&(b=t[t.length-2].short_name),i}function s(e){O.animate({color:"transparent"},300,function(){O.val(e).animate({color:"#FAFAFA"},300,function(){c()})})}function c(){return k?(U.show(),A.empty(),m(),P.css("display","block"),f("#apps-container"),void p()):void u("Please enter a valid location in the search bar")}function p(){var t,n=R.data("genreid"),a=O.val();t=a.indexOf(",")===-1?a:a.substring(0,a.indexOf(",")),t=encodeURIComponent(t);var o="https://itunes.apple.com/search?term="+t+"&genreId="+n+"&country="+b+"&lang=en_us&media=software&entity=software&sort=recent&callback=?";e.getJSON(o,function(e){if(e){results=e.results;var n=l(results,t);g(n)}P.css("display","none"),f("#apps-container")})}function l(e,t){for(var n=t,a=new RegExp(n,"gi"),o=_.text(),r=new RegExp(o,"gi"),i=0;i<e.length;i++){var d=e[i],s=d.trackName,c=String(d.description),p=(s.match(a)||[]).length,l=(c.match(a)||[]).length,g=(s.match(r)||[]).length,u=(c.match(r)||[]).length,m=d.averageUserRating,f=d.userRatingCount,h=(e.length-i)/e.length*5,v=100,w=3.5+p+l/2,y=200,b=3.5+g+u/2,k=100;w>5&&(w=5),b>5&&(b=5),m?d.weightedRating=(m*f+h*v+w*y+b*k)/(f+v+y+k):d.weightedRating=(h*v+w*y+b*k)/(v+y+k)}return rankedList=e.slice(0),rankedList.sort(function(e,t){return t.weightedRating-e.weightedRating}),rankedList}function g(t){if(m(),!t.length)return void u("No app found. Please try another populated city area nearby.");for(var a=e(n.createDocumentFragment()),o=0;o<t.length;o++){var r=t[o];a.append(e("<article/>",{"class":"app-item"}).append(e("<img/>",{"class":"app-img"}).attr("src",r.artworkUrl100)).append(e("<p/>",{"class":"app-title",text:r.trackName})).append(e("<p>",{"class":"app-rating ",text:"City Apps Rating: "+r.weightedRating.toFixed(2)})).append(e("<p/>",{"class":"app-description ",text:r.description})).append(e("<p/>",{"class":"app-download "}).append(e("<a/>",{"class":"download-btn"}).attr({href:r.trackViewUrl,target:"_blank",role:"button"}).html("Download &raquo;"))).append(e("<br>")).append(e("<hr>")).append(e("<br>")))}A.append(a)}function u(e){U.show(),A.empty(),B.show().text(e),f("#message")}function m(){B.hide()}function f(t){"bottom"===t||(E.stop(),E.animate({scrollTop:e(t).offset().top},800))}function h(t){function n(n,o){if("keydown"==n){var r=o;o=function(n){var a=e(".pac-item-selected").length>0;if(13==n.which&&!a){var o=e.Event("keydown",{keyCode:40,which:40});r.apply(t,[o])}r.apply(t,[n])}}a.apply(t,[n,o])}var a=t.addEventListener?t.addEventListener:t.attachEvent;t.addEventListener?t.addEventListener=n:t.attachEvent&&(t.attachEvent=n)}var v,w,y,b,k=!1,x=e(t),E=e("html, body"),L=e("#background-video"),R=e("#purpose-label"),_=e("#purpose-text"),C=e("#purpose-list"),D=(e(".dropdown-item"),e("#top-btn")),N=e("#locate-btn"),F=e("#search-btn"),S=e("#search-form"),O=e("#city-input"),U=e("#apps-container"),A=e("#apps-list"),P=e("#search-loader"),B=e("#message");return{init:a}}(window.jQuery,window,document);