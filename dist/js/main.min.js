function initAutocomplete(){autocomplete=new google.maps.places.Autocomplete(document.getElementById("city-input"),{types:["(cities)"]}),geocoder=new google.maps.Geocoder;var t=document.getElementById("city-input");selectFirstOnEnter(t),google.maps.event.addDomListener(t,"keydown",function(t){13===t.keyCode&&t.preventDefault()}),$("#background-video").css("opacity",0).animate({opacity:1},2500),autocomplete.addListener("place_changed",getPlace),$("#purpose-label").on("click",function(){$("#purpose-list").toggleClass("dropdown-open")}),$("html, body").bind("scroll mousedown DOMMouseScroll mousewheel keyup",function(){$("html, body").stop()}),$(window).scroll(function(){$(this).scrollTop()>1.5*$(window).height()?$("#top-btn").fadeIn():$("#top-btn").fadeOut()}),$("#top-btn").click(function(){return $("html, body").animate({scrollTop:0},800),!1}),$(window).click(function(t){t.target.matches("#purpose-label")||t.target.matches("#purpose-text")||t.target.matches("#dropdown-icon")||$("#purpose-list").hasClass("dropdown-open")&&$("#purpose-list").removeClass("dropdown-open")}),$(".dropdown-item").click(function(){var t=$(this).data("genreid"),e=$(this).text();$("#purpose-label").data("genreid",t),$("#purpose-text").text(e)}),$("#locate-btn").click(function(t){t.preventDefault(),getCurrentPosition()}),$("#search-btn").click(function(t){t.preventDefault(),$("#search-form").submit()}),$("#search-form").submit(function(t){t.preventDefault(),searchApps()})}function getPlace(){var t=autocomplete.getPlace();if(!t.geometry)return void(isValidLocation=!1);isValidLocation=!0;var e=t.formatted_address,o=t.address_components,n=formatCityInputText(e,o,!1);fillInCityInput(n)}function getCurrentPosition(){return currentCity?void fillInCityInput(currentCity):void(navigator.geolocation?($("#city-input").attr("placeholder","Locating..."),$("#city-input").val(""),$("#city-input").prop("disabled",!0),navigator.geolocation.getCurrentPosition(function(t){var e=t.coords.latitude,o=t.coords.longitude,n=new google.maps.LatLng(e,o);geocoder.geocode({latLng:n},function(t,e){e==google.maps.GeocoderStatus.OK?t[1]?$.each(t,function(t,e){if(isValidLocation=!0,"locality"==e.types[0]){var o=e.formatted_address,n=e.address_components,a=formatCityInputText(o,n,!0);return fillInCityInput(a),void $("#city-input").prop("disabled",!1)}}):(showMessage("No results found."),$("#city-input").prop("disabled",!1),$("#city-input").attr("placeholder",""),isValidLocation=!1):(alert("Geocoder failed due to: "+e),$("#city-input").prop("disabled",!1),$("#city-input").attr("placeholder",""),isValidLocation=!1)})},function(t){$("#city-input").prop("disabled",!1),$("#city-input").attr("placeholder",""),showMessage("Your location detection is disabled."),isValidLocation=!1})):showMessage("Your browser doen not support geolocation."))}function formatCityInputText(t,e,o){var n,a=e[0].long_name,i=e[e.length-1].short_name;e[3]&&(n=e[3].short_name);var r;if("US"===i||"US"===n){e[2].short_name;r=t.substring(0,t.indexOf(",")+4)}else r="GB"===i?t:a+", "+i;return o&&(currentCity=r),countryCode=i.toLowerCase(),countryCode.length>2&&(countryCode=e[e.length-2].short_name),r}function fillInCityInput(t){$("#city-input").animate({color:"transparent"},300,function(){$("#city-input").val(t).animate({color:"#FAFAFA"},300,function(){searchApps()})})}function searchApps(){return isValidLocation?($("#apps").show(),$("#apps-list").empty(),hideMessage(),$(".loader").css("display","block"),scrollTo("#apps"),void requestApps()):void showMessage("Please enter a valid location in the search bar")}function requestApps(){var t,e=$("#purpose-label").data("genreid"),o=$("#city-input").val();t=o.indexOf(",")===-1?o:o.substring(0,o.indexOf(",")),t=encodeURIComponent(t);var n="https://itunes.apple.com/search?term="+t+"&genreId="+e+"&country="+countryCode+"&lang=en_us&media=software&entity=software&sort=recent&callback=?";$.getJSON(n,function(e){if(e){results=e.results;var o=rankApps(results,t);populateList(o)}$(".loader").css("display","none"),scrollTo("#apps")})}function rankApps(t,e){for(var o=e,n=new RegExp(o,"gi"),a=$("#purpose-text").text(),i=new RegExp(a,"gi"),r=0;r<t.length;r++){var s=t[r],p=s.trackName,c=String(s.description),l=(p.match(n)||[]).length,d=(c.match(n)||[]).length,u=(p.match(i)||[]).length,g=(c.match(i)||[]).length,h=s.averageUserRating,m=s.userRatingCount,f=(t.length-r)/t.length*5,y=100,v=3.5+l+d/2,w=200,b=3.5+u+g/2,C=100;v>5&&(v=5),b>5&&(b=5),h?s.weightedRating=(h*m+f*y+v*w+b*C)/(m+y+w+C):s.weightedRating=(f*y+v*w+b*C)/(y+w+C)}return rankedList=t.slice(0),rankedList.sort(function(t,e){return e.weightedRating-t.weightedRating}),rankedList}function populateList(t){if(hideMessage(),!t.length)return void showMessage("No app found. Please try another populated city area nearby.");for(var e=0;e<t.length;e++){var o=t[e];$("#apps-list").append($("<article/>",{"class":"app-item"}).append($("<img/>",{"class":"app-img"}).attr("src",o.artworkUrl100)).append($("<p/>",{"class":"app-title",text:o.trackName})).append($("<p>",{"class":"app-rating ",text:"City Apps Rating: "+o.weightedRating.toFixed(2)})).append($("<p/>",{"class":"app-description ",text:o.description})).append($("<p/>",{"class":"app-download "}).append($("<a/>",{"class":"download-btn"}).attr({href:o.trackViewUrl,target:"_blank",role:"button"}).html("Download &raquo;"))).append($("<br>")).append($("<hr>")).append($("<br>")))}}function showMessage(t){$("#apps").show(),$("#apps-list").empty(),$("#message").show().text(t),scrollTo("#message")}function hideMessage(){$("#message").hide()}function scrollTo(t){"bottom"===t||($("html, body").stop(),$("html, body").animate({scrollTop:$(t).offset().top},800))}function selectFirstOnEnter(t){function e(e,n){if("keydown"==e){var a=n;n=function(e){var o=$(".pac-item-selected").length>0;if(13==e.which&&!o){var n=$.Event("keydown",{keyCode:40,which:40});a.apply(t,[n])}a.apply(t,[e])}}o.apply(t,[e,n])}var o=t.addEventListener?t.addEventListener:t.attachEvent;t.addEventListener?t.addEventListener=e:t.attachEvent&&(t.attachEvent=e)}var autocomplete,geocoder,currentCity,isValidLocation=!1,countryCode;